https://github.com/kardianos/govendor
gin run
export PATH=$PATH:/usr/local/go/bin
export PATH=$PATH:~/go/bin/
http://localhost:3000/user/ismajl/resource/nature.jpeg/modifiers/resizew120h120
http://localhost:3000/user/ismajl/resource/nature.jpeg
localhost:3000/user/ismajl/resource/nature.jpeg/modifiers/resize_w100_h100
// fmt.Println(providerUrl)
// response, e := http.Get(providerUrl)
// if e != nil {
// 	log.Fatal(e)
// }
// defer response.Body.Close()
// w.Header().Set("Content-Type", "image/jpeg")
// io.Copy(w, response.Body)
// func createKeyValuePairs(m map[string][]string) string {
// 	b := new(bytes.Buffer)
// 	for key, value := range m {
// 		fmt.Fprintf(b, " %s=\"%s\"", key, value[0])
// 	}
// 	return b.String()
// }
govendor add +external


	// var orHash string
	// var mdfHash string
	// var userId int32
	// var ftype int32
	// var allowedOperations string
	//
	// for rows.Next() {
	// 	var hash string
	// 	var ao sql.NullString
	// 	err = rows.Scan(&hash, &userId, &ftype, &ao)
	// 	if err != nil {
	// 		log.Fatal(err)
	// 	}
	//
	// 	if ftype == 0 {
	// 		orHash = hash
	// 		if ao.Valid {
	// 			allowedOperations = ao.String
	// 		}
	// 	}
	//
	// 	if ftype == 1 {
	// 		mdfHash = hash
	// 	}
	// }
	// fmt.Println("end querying db")
	// if mdfHash != "" || paramModifiers == "" {
	// 	fmt.Println("downloading resource...")
	// 	// get file from storage using hash and return as image
	// 	providerUrl := fmt.Sprintf(
	// 		"https://storage.googleapis.com/imgmdf/%d/%s",
	// 		userId,
	// 		orHash,
	// 	)
	// 	if mdfHash != "" {
	// 		providerUrl = fmt.Sprintf("%s_/%s", providerUrl, mdfHash)
	// 	}
	// 	u, err := url.Parse(providerUrl)
	// 	if err != nil {
	// 		panic(err)
	// 	}
	//
	// 	buf, err := fetchImage(u)
	//
	// 	if err != nil {
	// 		return
	// 	}
	// 	w.Header().Set("Content-Length", strconv.Itoa(len(buf)))
	// 	w.Header().Set("Content-Type", "image/jpeg")
	// 	w.Write(buf)
	// 	db.Close()
	// 	fmt.Println("served from cache")
	// 	fmt.Println("done")
	// 	return
	// }
	//
	// // original resource
	// // 2. Check if user has permissions to perform transformations
	// // add allowed operations in file table on hash form
	// //...
	//
	// if userHasPermissionsToPerformOperations(allowedOperations, paramModifiers) {
	// 	// 3. Check if resource exists for user
	// 	var providerUrl string
	// 	if orHash != "" {
	// 		fmt.Println("original resource hash %s", orHash)
	// 		providerUrl = fmt.Sprintf(
	// 			"https://storage.googleapis.com/imgmdf/%d/%s",
	// 			userId,
	// 			orHash)
	// 	} else {
	// 		// 4. If resource doesn't exists, check if resource is url
	// 		// If it's url, then try to download the resource and save in
	// 		// blob storage and in db
	// 		providerUrl = paramResource
	// 		fmt.Println("resource does not exist", paramResource)
	// 		u, err := url.Parse(paramResource)
	// 		if err != nil {
	// 			panic(err)
	// 		}
	// 		buf, err := fetchImage(u)
	// 		if err != nil {
	// 			panic(err)
	// 		}
	// 		fmt.Print(len(buf))
	//
	// 		// Sets the name for the new bucket.
	// 		saveObject(fileObject{Body: buf, Name: "1/" + resHash})
	//
	// 		sqlStatement := `
	// 		INSERT INTO public.file
	// 			(created_at, modified_at, last_opened, guid, hash, "index", parent_id, visible, "name", description, "type", allowed_operations, performed_operations)
	// 			VALUES(now(), now(), now(), $1, $2, 0, null, true, $3, '', 0, '', $4) RETURNING id;`
	// 		fileGuid, err := uuid.NewRandom()
	// 		fmt.Print("fileGuid", fileGuid)
	// 		if err != nil {
	// 			log.Fatal(err)
	// 		}
	//
	// 		fmt.Printf("%s", fileGuid)
	// 		var newFileId int
	// 		errIn := db.QueryRow(sqlStatement, fileGuid, resHash, paramResource, resourceModifiers).Scan(&newFileId)
	// 		if errIn != nil {
	// 			log.Fatal(errIn)
	// 		}
	// 		fmt.Printf("%s", fileGuid)
	//
	// 		insertUserFile := `
	// 		INSERT INTO public.user_file
	// 		(user_id,
	// 			file_id,
	// 			"type",
	// 			"role",
	// 			created_at,
	// 			modified_at, visible) VALUES($1, $2, 1, 0, now(), now(), true);`
	// 		fmt.Println("New record ID is:", newFileId)
	//
	// 		//userId when resource is url
	// 		_, errInsert := db.Exec(insertUserFile, 1, newFileId)
	// 		if errInsert != nil {
	// 			panic(err)
	// 		}
	// 		providerUrl = fmt.Sprintf(
	// 			"https://storage.googleapis.com/imgmdf/%d/%s",
	// 			1,
	// 			resHash)
	// 		fmt.Println("providerUrl", providerUrl)
	// 	}
	//
	// 	u, err := url.Parse(providerUrl)
	// 	if err != nil {
	// 		panic(err)
	// 	}
	// 	fmt.Print(providerUrl)
	//
	// 	buf, err := fetchImage(u)
	// 	if err != nil {
	// 		panic(err)
	// 	}
	// 	//fmt.Print(buf)
	// 	r := bytes.NewReader(buf)
	// 	img, err := jpeg.Decode(r)
	// 	if err != nil {
	// 		log.Fatal(err)
	// 	}
	//
	// 	modifiers := strings.Split(resourceModifiers, "_")
	// 	if len(modifiers) > 0 {
	// 		widthStr := modifiers[1]
	// 		heightStr := modifiers[2]
	// 		width, e := strconv.ParseUint(strings.Replace(widthStr, "w", "", -1), 10, 32)
	// 		height, e := strconv.ParseUint(strings.Replace(heightStr, "h", "", -1), 10, 32)
	//
	// 		if e != nil {
	// 			log.Fatal(err)
	// 		}
	//
	// 		// 5. Perform transformations,
	// 		// and save transformed image to blob and db
	// 		newImage := resize.Resize(uint(width), uint(height), img, resize.Lanczos3)
	//
	// 		bufOut := new(bytes.Buffer)
	// 		err = jpeg.Encode(bufOut, newImage, nil)
	// 		sendBuf := bufOut.Bytes()
	// 		fileName := "1/" + orHash + "_/" + resModHash
	// 		saveObject(fileObject{Body: sendBuf, Name: fileName})
	//
	// 		//save metadata in db
	// 		sqlStatement := `
	// 		INSERT INTO public.file
	// 			(created_at, modified_at, last_opened, guid, hash, "index", parent_id, visible, "name", description, "type", allowed_operations, performed_operations)
	// 			VALUES(now(), now(), now(), $1, $2, 0, null, true, $3, '', 1, '', $4) RETURNING id;`
	// 		fileGuid, err := uuid.NewRandom()
	// 		fmt.Print("fileGuid", fileGuid)
	// 		if err != nil {
	// 			log.Fatal(err)
	// 		}
	//
	// 		fmt.Printf("%s", fileGuid)
	// 		var newFileId int
	// 		errIn := db.QueryRow(sqlStatement, fileGuid, resModHash, paramResource, resourceModifiers).Scan(&newFileId)
	// 		if errIn != nil {
	// 			log.Fatal(errIn)
	// 		}
	//
	// 		insertUserFile := `
	// 		INSERT INTO public.user_file
	// 		(user_id,
	// 		 	file_id,
	// 			"type",
	// 		 	"role",
	// 			created_at,
	// 		  modified_at, visible) VALUES($1, $2, 1, 0, now(), now(), true);`
	// 		fmt.Println("New record ID is:", newFileId)
	//
	// 		//userId when resource is url
	// 		_, errInsert := db.Exec(insertUserFile, 1, newFileId)
	// 		if errInsert != nil {
	// 			panic(err)
	// 		}
	//
	// 		// 6. Return edited image
	// 		w.Header().Set("Content-Length", strconv.Itoa(len(sendBuf)))
	// 		w.Header().Set("Content-Type", "image/jpeg")
	// 		w.Write(sendBuf)
	// 		db.Close()
	// 		return
	//	}
	//}
